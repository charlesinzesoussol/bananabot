<!DOCTYPE html>
<html>
<head>
    <title>BananaBot Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: #2d2d2d; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .metric { text-align: center; padding: 20px; }
        .metric h3 { margin: 0; color: #4CAF50; }
        .metric .value { font-size: 2em; font-weight: bold; }
        canvas { max-height: 300px; }
        .status.online { color: #4CAF50; }
        .status.offline { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçå BananaBot Monitoring Dashboard</h1>
        
        <div class="grid">
            <div class="card metric">
                <h3>Bot Status</h3>
                <div class="value status" id="status">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Guild Count</h3>
                <div class="value" id="guilds">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Memory Usage</h3>
                <div class="value" id="memory">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Total Downloads</h3>
                <div class="value" id="downloads">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card metric">
                <h3>Active Users (24h)</h3>
                <div class="value" id="activeUsers">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Images Generated (24h)</h3>
                <div class="value" id="generations">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Cost Today</h3>
                <div class="value" id="cost">Loading...</div>
            </div>
            <div class="card metric">
                <h3>Disk Usage</h3>
                <div class="value" id="disk">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Memory Usage Over Time</h3>
                <canvas id="memoryChart"></canvas>
            </div>
            <div class="card">
                <h3>Image Generation Activity</h3>
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Load latest metrics from GitHub repository
        async function loadMetrics() {
            try {
                // Load real metrics from the monitoring directory
                const response = await fetch('https://api.github.com/repos/charlesinzesoussol/bananabot/contents/monitoring');
                const files = await response.json();
                
                // Get the latest metrics file
                const latestFile = files
                    .filter(f => f.name.endsWith('.json') && f.name !== 'dashboard.html')
                    .sort((a, b) => b.name.localeCompare(a.name))[0];
                
                if (latestFile) {
                    const metricsResponse = await fetch(latestFile.download_url);
                    const metrics = await metricsResponse.json();
                    
                    // Update metrics display with real data
                    document.getElementById('status').textContent = metrics.bot_status;
                    document.getElementById('status').className = `value status ${metrics.bot_status === 'active' ? 'online' : 'offline'}`;
                    document.getElementById('guilds').textContent = metrics.guild_count;
                    document.getElementById('memory').textContent = metrics.memory_usage + '%';
                    document.getElementById('downloads').textContent = metrics.total_downloads;
                    document.getElementById('activeUsers').textContent = metrics.active_users_24h;
                    document.getElementById('generations').textContent = metrics.recent_activity_24h;
                    document.getElementById('cost').textContent = '$' + parseFloat(metrics.total_cost_today).toFixed(4);
                    document.getElementById('disk').textContent = metrics.disk_usage + '%';
                    
                    // Create charts with historical data
                    await createChartsWithHistoricalData(files);
                } else {
                    // Fallback to placeholder data
                    showPlaceholderData();
                }
                
            } catch (error) {
                console.error('Failed to load metrics:', error);
                showPlaceholderData();
            }
        }
        
        function showPlaceholderData() {
            document.getElementById('status').textContent = 'No Data';
            document.getElementById('guilds').textContent = 'No Data';
            document.getElementById('memory').textContent = 'No Data';
            document.getElementById('downloads').textContent = 'No Data';
            document.getElementById('activeUsers').textContent = 'No Data';
            document.getElementById('generations').textContent = 'No Data';
            document.getElementById('cost').textContent = 'No Data';
            document.getElementById('disk').textContent = 'No Data';
            // Don't create charts if no data
            document.getElementById('memoryChart').parentElement.innerHTML = '<h3>No Data Available</h3><p>Run the monitoring workflow to collect metrics</p>';
            document.getElementById('activityChart').parentElement.innerHTML = '<h3>No Data Available</h3><p>Run the monitoring workflow to collect metrics</p>';
        }
        
        async function createChartsWithHistoricalData(files) {
            try {
                // Get last 12 data points for charts
                const dataFiles = files
                    .filter(f => f.name.endsWith('.json'))
                    .sort((a, b) => b.name.localeCompare(a.name))
                    .slice(0, 12);
                
                const historicalData = [];
                for (const file of dataFiles.reverse()) {
                    try {
                        const response = await fetch(file.download_url);
                        const data = await response.json();
                        historicalData.push({
                            timestamp: data.timestamp,
                            memory: parseFloat(data.memory_usage) || 0,
                            activity: parseInt(data.recent_activity_24h) || 0
                        });
                    } catch (e) {
                        console.warn('Failed to load file:', file.name);
                    }
                }
                
                if (historicalData.length > 0) {
                    createChartsWithData(historicalData);
                } else {
                    createCharts(); // Fallback to sample data
                }
            } catch (error) {
                console.error('Failed to create historical charts:', error);
                createCharts(); // Fallback to sample data
            }
        }
        
        function createChartsWithData(historicalData) {
            const labels = historicalData.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const memoryData = historicalData.map(d => d.memory);
            const activityData = historicalData.map(d => d.activity);
            
            // Memory usage chart
            const memCtx = document.getElementById('memoryChart').getContext('2d');
            new Chart(memCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Memory %',
                        data: memoryData,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: '#444' } },
                        y: { ticks: { color: 'white' }, grid: { color: '#444' } }
                    }
                }
            });
            
            // Activity chart
            const actCtx = document.getElementById('activityChart').getContext('2d');
            new Chart(actCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Images Generated (24h)',
                        data: activityData,
                        backgroundColor: '#FF9800',
                        borderColor: '#F57F17',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: '#444' } },
                        y: { ticks: { color: 'white' }, grid: { color: '#444' } }
                    }
                }
            });
        }
        
        function createCharts() {
            // Fallback sample data charts
            createChartsWithData([
                { timestamp: new Date(Date.now() - 4*15*60000).toISOString(), memory: 42, activity: 5 },
                { timestamp: new Date(Date.now() - 3*15*60000).toISOString(), memory: 45, activity: 8 },
                { timestamp: new Date(Date.now() - 2*15*60000).toISOString(), memory: 43, activity: 3 },
                { timestamp: new Date(Date.now() - 1*15*60000).toISOString(), memory: 47, activity: 12 },
                { timestamp: new Date().toISOString(), memory: 45, activity: 7 }
            ]);
        }
        
        // Load data when page loads
        loadMetrics();
        
        // Refresh every 5 minutes
        setInterval(loadMetrics, 5 * 60 * 1000);
    </script>
</body>
</html>